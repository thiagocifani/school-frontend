#!/bin/bash

# School System Frontend - Heroku Deployment Script

set -e  # Exit on any error

echo "ğŸš€ Starting deployment of School System Frontend..."

# Check if we're in the right directory
if [ ! -f "package.json" ]; then
    echo "âŒ Error: package.json not found. Please run this script from the frontend root directory."
    exit 1
fi

# Clean up any problematic directories
echo "ğŸ§¹ Cleaning up build artifacts..."
rm -rf .next/
rm -rf node_modules/.cache/

# Check if Heroku CLI is installed
if ! command -v heroku &> /dev/null; then
    echo "âŒ Error: Heroku CLI is not installed."
    echo "   Please install it from: https://devcenter.heroku.com/articles/heroku-cli"
    exit 1
fi

# Check if logged into Heroku
if ! heroku auth:whoami &> /dev/null; then
    echo "âŒ Error: Please login to Heroku first:"
    echo "   heroku login"
    exit 1
fi

# Get app names from command line arguments or prompt
if [ -z "$1" ]; then
    echo -n "Enter your Heroku app name for the frontend: "
    read FRONTEND_APP_NAME
else
    FRONTEND_APP_NAME=$1
fi

if [ -z "$2" ]; then
    echo -n "Enter your Heroku app name for the API: "
    read API_APP_NAME
else
    API_APP_NAME=$2
fi

echo "ğŸ“± Deploying frontend to: $FRONTEND_APP_NAME"
echo "ğŸ”— Connecting to API: $API_APP_NAME"

# Check if app exists, create if it doesn't
if ! heroku apps:info $FRONTEND_APP_NAME &> /dev/null; then
    echo "ğŸ“ App doesn't exist. Creating new Heroku app: $FRONTEND_APP_NAME"
    heroku create $FRONTEND_APP_NAME
else
    echo "âœ… App exists: $FRONTEND_APP_NAME"
fi

# Set required environment variables
echo "âš™ï¸  Setting environment variables..."
heroku config:set NODE_ENV=production --app $FRONTEND_APP_NAME
heroku config:set NPM_CONFIG_PRODUCTION=false --app $FRONTEND_APP_NAME
heroku config:set NEXT_PUBLIC_API_URL=https://$API_APP_NAME.herokuapp.com/api/v1 --app $FRONTEND_APP_NAME

# Deploy to Heroku
echo "ğŸš¢ Deploying to Heroku..."
git add .
git commit -m "Deploy frontend to Heroku - $(date)" || echo "No changes to commit"

# Add heroku remote if it doesn't exist
if ! git remote get-url heroku-frontend &> /dev/null; then
    git remote add heroku-frontend https://git.heroku.com/$FRONTEND_APP_NAME.git
fi

git push heroku-frontend main

# Scale web dyno
echo "âš–ï¸  Scaling dynos..."
heroku ps:scale web=1 --app $FRONTEND_APP_NAME

# Update API CORS settings
echo "ğŸ”— Updating API CORS settings..."
heroku config:set FRONTEND_URL=https://$FRONTEND_APP_NAME.herokuapp.com --app $API_APP_NAME

echo "âœ… Deployment completed successfully!"
echo "ğŸŒ Your frontend is available at: https://$FRONTEND_APP_NAME.herokuapp.com"

echo -n "Do you want to open the app? (y/n): "
read OPEN_APP
if [[ $OPEN_APP == "y" || $OPEN_APP == "Y" ]]; then
    heroku open --app $FRONTEND_APP_NAME
fi

echo "ğŸ“Š To view logs: heroku logs --tail --app $FRONTEND_APP_NAME"
echo "ğŸ‰ Frontend deployment complete!"